/*!
* jQuery HTML5 Uploader 1.0b
*
* http://www.igloolab.com/jquery-html5-uploader
*/
(function($){
$.fn.html5Uploader=function(options){
	var crlf='\r\n';var boundary="iloveigloo";
	var dashes="--";
	var settings={"name":"uploadedFile",
					"postUrl":"Upload.aspx",
					"onClientAbort":null,
					"onClientError":null,
					"onClientLoad":null,
					"onClientLoadEnd":null,
					"onClientLoadStart":null,
					"onClientProgress":null,
					"onServerAbort":null,
					"onServerError":null,
					"onServerLoad":null,
					"onServerLoadStart":null,
					"onServerProgress":null,
					"onServerReadyStateChange":null

				};
	
	if(options){$.extend(settings,options);}
		return this.each(function(options){var $this=$(this);
		if($this.is("[type='file']")){$this
.bind("change",function(){
	var files=this.files;
	for(var i=0;i<files.length;i++){
			console.log("HANDLING FILE:");
			console.log(files[i]);

			console.log("FROM");
			console.log($(this).attr('id'));
			fileHandler(files[i], $(this));
			}
		});
			}else{$this
.bind("dragenter dragover",function(){return false;})
.bind("drop",function(e){
	var files=e.originalEvent.dataTransfer.files;
	for(var i=0;i<files.length;i++){
		fileHandler(files[i], $(this));
		console.log("ADDING FILE TO ");
		console.log($(this));
	}
return false;});}});

function fileHandler(file, uploaderDomElement){
	var fileReader=new FileReader();
	fileReader.wibble='wobble';
	fileReader.onabort=function(e){if(settings.onClientAbort){settings.onClientAbort(e,file, uploaderDomElement);}};
fileReader.onerror=function(e){if(settings.onClientError){settings.onClientError(e,file, uploaderDomElement);}};
fileReader.onload=function(e){if(settings.onClientLoad){settings.onClientLoad(e,file, uploaderDomElement);}};
fileReader.onloadend=function(e){if(settings.onClientLoadEnd){settings.onClientLoadEnd(e,file, uploaderDomElement);}};
fileReader.onloadstart=function(e){if(settings.onClientLoadStart){settings.onClientLoadStart(e,file, uploaderDomElement);}};
fileReader.onprogress=function(e){if(settings.onClientProgress){settings.onClientProgress(e,file, uploaderDomElement);}};
fileReader.readAsDataURL(file);
var xmlHttpRequest=new XMLHttpRequest();
xmlHttpRequest.upload.onabort=function(e){if(settings.onServerAbort){settings.onServerAbort(e,file, uploaderDomElement);}};xmlHttpRequest.upload.onerror=function(e){if(settings.onServerError){settings.onServerError(e,file);}};xmlHttpRequest.upload.onload=function(e){if(settings.onServerLoad){settings.onServerLoad(e,file);}};xmlHttpRequest.upload.onloadstart=function(e){if(settings.onServerLoadStart){settings.onServerLoadStart(e,file);}};xmlHttpRequest.upload.onprogress=function(e){if(settings.onServerProgress){settings.onServerProgress(e,file);}};
xmlHttpRequest.onreadystatechange=function(e){
	e.wibble=$(this).attr('id');
	console.log(" IN EVENT CREATION");
	console.log($(this));

	//console.log("PARENT:"+$(this).parent);
	if(settings.onServerReadyStateChange) {
		//console.log("ONREADYSTATECHANGE");
		//console.log(this);
		settings.onServerReadyStateChange(e,file, uploaderDomElement);
	}
};

var uploaderID = uploaderDomElement.attr('id');
var fileClass = uploaderDomElement.attr('file_class');
var imageClass = uploaderDomElement.attr('image_class');


xmlHttpRequest.open("POST",settings.postUrl+"?image_class="+imageClass+"&file_class="+fileClass+"&FolderID="+$('#UploadFolderID_'+uploaderID).val(),true);
if(file.getAsBinary){var data=dashes+boundary+crlf+
"Content-Disposition: form-data;"+
"name=\""+settings.name+"\";"+
"filename=\""+unescape(encodeURIComponent(file.name))+"\""+crlf+
"Content-Type: application/octet-stream"+crlf+crlf+
file.getAsBinary()+crlf+
dashes+boundary+dashes;xmlHttpRequest.setRequestHeader("Content-Type","multipart/form-data;boundary="+boundary);
xmlHttpRequest.sendAsBinary(data);}else 
if(window.FormData){
	var formData=new FormData();
	formData.append(settings.name,file);
	xmlHttpRequest.send(formData);
}

console.log("XMLHTTPREQ DONE <<<<<");
console.log(xmlHttpRequest);
console.log(xmlHttpRequest.response);
console.log(xmlHttpRequest['response']);

}}



;}
)(jQuery);